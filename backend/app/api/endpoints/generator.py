from fastapi import Depends, APIRouter, HTTPException, status
from app.reports.engine import get_reports_engine
import logging
import re
from typing import List

router = APIRouter()
logger = logging.getLogger(__name__)


# TODO: move them to utils folder
def separate_numbers(match):
    numbers = match.group(1)
    return "".join([f"[{num}]" for num in numbers.split(",")])


@router.get("/")
async def get_building_block(promptType: str, offset: int, citations_ids: List[str]):
    """
    Get the competitive advantage of the company
    """
    # res = get_reports_engine("0001018724")
    res = {
        "text": "Apple Inc., founded in 1976, is a multinational technology company primarily operating in the consumer electronics, software, and online services industries. The company's key products include iPhone (52% of 2023 net sales), Mac (8%), iPad (7%), Wearables, Home and Accessories (10%), and Services (22%), which includes advertising, AppleCare, cloud services, payment services, and digital content through the App Store and Apple TV+, among others [1,2]. Apple's major markets include the Americas, Europe, Greater China, Japan, and Rest of Asia Pacific [3,4]. In fiscal year 2023, Apple reported total net sales of $383.3 billion, a 3% decrease from the previous year, while maintaining its position as a global leader in the technology industry [2].",
        "nodes": [
            {
                "node_id": "ac80cd9b-0dea-4736-9693-08abbcabf6dc",
                "text": "Services\nAdvertising\nThe Company’s advertising services include third-party licensing arrangements and the Company’s own advertising platforms.\nAppleCare\nThe Company offers a portfolio of fee-based service and support products under the AppleCare\n brand. The offerings provide priority access to Apple technical\nsupport, access to the global Apple authorized service network for repair and replacement services, and in many cases additional coverage for instances of accidental\ndamage or theft and loss, depending on the country and type of product.\nCloud Services\nThe Company’s cloud services store and keep customers’ content up-to-date and available across multiple Apple devices and Windows personal computers.\nDigital Content\nThe Company operates various platforms, including the App Store\n,\n that allow customers to discover and download applications and digital content, such as books,\nmusic, video, games and podcasts.\nThe Company also offers digital content through subscription-based services, including Apple Arcade\n, a game subscription service; Apple Fitness+\n, a personalized\nﬁtness service; Apple Music\n, which offers users a curated listening experience with on-demand radio stations; Apple News+\n, a subscription news and magazine\nservice; and Apple TV+\n, which offers exclusive original content and live sports.\nPayment Services\nThe Company offers payment services, including Apple Card\n, a co-branded credit card, and Apple Pay\n, a cashless payment service.\nSegments\nThe Company manages its business primarily on a geographic basis. The Company’s reportable segments consist of the Americas, Europe, Greater China, Japan\nand Rest of Asia Paciﬁc. Americas includes both North and South America. Europe includes European countries, as well as India, the Middle East and Africa. Greater\nChina includes China mainland, Hong Kong and Taiwan. Rest of Asia Paciﬁc includes Australia and those Asian countries not included in the Company’s other\nreportable segments. Although the reportable segments provide similar hardware and software products and similar services, each one is managed separately to\nbetter align with the location of the Company’s customers and distribution partners and the unique market dynamics of each geographic region.\nMarkets and Distribution\nThe Company’s customers are primarily in the consumer, small and mid-sized business, education, enterprise and government markets. The Company sells its\nproducts and resells third-party products in most of its major markets directly to customers through its retail and online stores and its direct sales force. The Company\nalso employs a variety of indirect distribution channels, such as third-party cellular network carriers, wholesalers, retailers and resellers. During 2023, the Company’s\nnet sales through its direct and indirect distribution channels accounted for 37% and 63%, respectively, of total net sales.\nCompetition\nThe markets for the Company’s products and services are highly competitive, and are characterized by aggressive price competition and resulting downward pressure\non gross margins, frequent introduction of new products and services, short product life cycles, evolving industry standards, continual improvement in product price\nand performance characteristics, rapid adoption of technological advancements by competitors, and price sensitivity on the part of consumers and businesses. Many\nof the Company’s competitors seek to compete primarily through aggressive pricing and very low cost structures, and by imitating the Company’s products and\ninfringing on its intellectual property.\n®\n®\n®\nSM\n®\n®\n®\n®\n®\nApple Inc. | 2023 Form 10-K | 2",
                "source_num": 1,
            },
            {
                "node_id": "a1bb309d-bece-4df6-a702-81b57525dcca",
                "text": "Products and Services Performance\nThe following table shows net sales by category for 2023, 2022 and 2021 (dollars in millions):\n2023\nChange\n2022\nChange\n2021\nNet sales by category:\niPhone \n$\n200,583 \n(2)\n%\n$\n205,489 \n7 \n%\n$\n191,973 \nMac \n29,357 \n(27)\n%\n40,177 \n14 \n%\n35,190 \niPad \n28,300 \n(3)\n%\n29,292 \n(8)\n%\n31,862 \nWearables, Home and Accessories \n39,845 \n(3)\n%\n41,241 \n7 \n%\n38,367 \nServices \n85,200 \n9 \n%\n78,129 \n14 \n%\n68,425 \nTotal net sales\n$\n383,285 \n(3)\n%\n$\n394,328 \n8 \n%\n$\n365,817 \n(1)\nProducts net sales include amortization of the deferred value of unspeciﬁed software upgrade rights, which are bundled in the sales price of the respective\nproduct.\n(2)\nServices net sales include amortization of the deferred value of services bundled in the sales price of certain products.\niPhone\niPhone net sales decreased 2% or $4.9 billion during 2023 compared to 2022 due to lower net sales of non-Pro iPhone models, partially offset by higher net sales of\nPro iPhone models.\nMac\nMac net sales decreased 27% or $10.8 billion during 2023 compared to 2022 due primarily to lower net sales of laptops.\niPad\niPad net sales decreased 3% or $1.0 billion during 2023 compared to 2022 due primarily to lower net sales of iPad mini and iPad Air, partially offset by the combined\nnet sales of iPad 9th and 10th generation.\nWearables, Home and Accessories\nWearables, Home and Accessories net sales decreased 3% or $1.4 billion during 2023 compared to 2022 due primarily to lower net sales of Wearables and\nAccessories.\nServices\nServices net sales increased 9% or $7.1 billion during 2023 compared to 2022 due to higher net sales across all lines of business.\n(1)\n(1)\n(1)\n(1)\n(2)\nApple Inc. | 2023 Form 10-K | 22",
                "source_num": 2,
            },
            {
                "node_id": "eb815ea6-5d07-49d8-b090-4b73346b6815",
                "text": "Note 13 – \nSegment Information and Geographic Data\nThe Company manages its business primarily on a geographic basis. The Company’s reportable segments consist of the Americas, Europe, Greater China, Japan\nand Rest of Asia Paciﬁc. Americas includes both North and South America. Europe includes European countries, as well as India, the Middle East and Africa. Greater\nChina includes China mainland, Hong Kong and Taiwan. Rest of Asia Paciﬁc includes Australia and those Asian countries not included in the Company’s other\nreportable segments. Although the reportable segments provide similar hardware and software products and similar services, each one is managed separately to\nbetter align with the location of the Company’s customers and distribution partners and the unique market dynamics of each geographic region.\nThe Company evaluates the performance of its reportable segments based on net sales and operating income. Net sales for geographic segments are generally\nbased on the location of customers and sales through the Company’s retail stores located in those geographic locations. Operating income for each segment consists\nof net sales to third parties, related cost of sales, and operating expenses directly attributable to the segment. The information provided to the Company’s chief\noperating decision maker for purposes of making decisions and assessing segment performance excludes asset information.\nThe following table shows information by reportable segment for 2023, 2022 and 2021 (in millions):\n2023\n2022\n2021\nAmericas:\nNet sales\n$\n162,560\n \n$\n169,658\n \n$\n153,306\n \nOperating income\n$\n60,508\n \n$\n62,683\n \n$\n53,382\n \nEurope:\nNet sales\n$\n94,294\n \n$\n95,118\n \n$\n89,307\n \nOperating income\n$\n36,098\n \n$\n35,233\n \n$\n32,505\n \nGreater China:\nNet sales\n$\n72,559\n \n$\n74,200\n \n$\n68,366\n \nOperating income\n$\n30,328\n \n$\n31,153\n \n$\n28,504\n \nJapan:\nNet sales\n$\n24,257\n \n$\n25,977\n \n$\n28,482\n \nOperating income\n$\n11,888\n \n$\n12,257\n \n$\n12,798\n \nRest of Asia Pacific:\nNet sales\n$\n29,615\n \n$\n29,375\n \n$\n26,356\n \nOperating income\n$\n12,066\n \n$\n11,569\n \n$\n9,817\n \nA reconciliation of the Company’s segment operating income to the Consolidated Statements of Operations for 2023, 2022 and 2021 is as follows (in millions):\n2023\n2022\n2021\nSegment operating income\n$\n150,888\n \n$\n152,895\n \n$\n137,006\n \nResearch and development expense\n(\n29,915\n)\n(\n26,251\n)\n(\n21,914\n)\nOther corporate expenses, net \n(\n6,672\n)\n(\n7,207\n)\n(\n6,143\n)\nTotal operating income\n$\n114,301\n \n$\n119,437\n \n$\n108,949\n \n(1)\nIncludes corporate marketing expenses, certain share-based compensation expenses, various nonrecurring charges, and other separately managed general and\nadministrative costs.\n(1)\nApple Inc. | 2023 Form 10-K | 47",
                "source_num": 3,
            },
            {
                "node_id": "e011d010-de27-40f0-ac97-f6adf38c34f3",
                "text": "Segment Operating Performance\nThe following table shows net sales by reportable segment for 2023, 2022 and 2021 (dollars in millions):\n2023\nChange\n2022\nChange\n2021\nNet sales by reportable segment:\nAmericas\n$\n162,560 \n(4)\n%\n$\n169,658 \n11 \n%\n$\n153,306 \nEurope\n94,294 \n(1)\n%\n95,118 \n7 \n%\n89,307 \nGreater China\n72,559 \n(2)\n%\n74,200 \n9 \n%\n68,366 \nJapan\n24,257 \n(7)\n%\n25,977 \n(9)\n%\n28,482 \nRest of Asia Pacific\n29,615 \n1 \n%\n29,375 \n11 \n%\n26,356 \nTotal net sales\n$\n383,285 \n(3)\n%\n$\n394,328 \n8 \n%\n$\n365,817 \nAmericas\nAmericas net sales decreased 4% or $7.1 billion during 2023 compared to 2022 due to lower net sales of iPhone and Mac, partially offset by higher net sales of\nServices.\nEurope\nEurope net sales decreased 1% or $824 million during 2023 compared to 2022. The weakness in foreign currencies relative to the U.S. dollar accounted for more\nthan the entire year-over-year decrease in Europe net sales, which consisted primarily of lower net sales of Mac and Wearables, Home and Accessories, partially\noffset by higher net sales of iPhone and Services.\nGreater China\nGreater China net sales decreased 2% or $1.6 billion during 2023 compared to 2022. The weakness in the renminbi relative to the U.S. dollar accounted for more\nthan the entire year-over-year decrease in Greater China net sales, which consisted primarily of lower net sales of Mac and iPhone.\nJapan\nJapan net sales decreased 7% or $1.7 billion during 2023 compared to 2022. The weakness in the yen relative to the U.S. dollar accounted for more than the entire\nyear-over-year decrease in Japan net sales, which consisted primarily of lower net sales of iPhone, Wearables, Home and Accessories and Mac.\nRest of Asia Pacific\nRest of Asia Paciﬁc net sales increased 1% or $240 million during 2023 compared to 2022. The weakness in foreign currencies relative to the U.S. dollar had a\nsigniﬁcantly unfavorable year-over-year impact on Rest of Asia Paciﬁc net sales. The net sales increase consisted of higher net sales of iPhone and Services,\npartially offset by lower net sales of Mac and iPad.\nApple Inc. | 2023 Form 10-K | 21",
                "source_num": 4,
            },
            {
                "node_id": "ac80cd9b-0dea-4736-9693-08abbcabf6dc",
                "text": "Services\nAdvertising\nThe Company’s advertising services include third-party licensing arrangements and the Company’s own advertising platforms.\nAppleCare\nThe Company offers a portfolio of fee-based service and support products under the AppleCare\n brand. The offerings provide priority access to Apple technical\nsupport, access to the global Apple authorized service network for repair and replacement services, and in many cases additional coverage for instances of accidental\ndamage or theft and loss, depending on the country and type of product.\nCloud Services\nThe Company’s cloud services store and keep customers’ content up-to-date and available across multiple Apple devices and Windows personal computers.\nDigital Content\nThe Company operates various platforms, including the App Store\n,\n that allow customers to discover and download applications and digital content, such as books,\nmusic, video, games and podcasts.\nThe Company also offers digital content through subscription-based services, including Apple Arcade\n, a game subscription service; Apple Fitness+\n, a personalized\nﬁtness service; Apple Music\n, which offers users a curated listening experience with on-demand radio stations; Apple News+\n, a subscription news and magazine\nservice; and Apple TV+\n, which offers exclusive original content and live sports.\nPayment Services\nThe Company offers payment services, including Apple Card\n, a co-branded credit card, and Apple Pay\n, a cashless payment service.\nSegments\nThe Company manages its business primarily on a geographic basis. The Company’s reportable segments consist of the Americas, Europe, Greater China, Japan\nand Rest of Asia Paciﬁc. Americas includes both North and South America. Europe includes European countries, as well as India, the Middle East and Africa. Greater\nChina includes China mainland, Hong Kong and Taiwan. Rest of Asia Paciﬁc includes Australia and those Asian countries not included in the Company’s other\nreportable segments. Although the reportable segments provide similar hardware and software products and similar services, each one is managed separately to\nbetter align with the location of the Company’s customers and distribution partners and the unique market dynamics of each geographic region.\nMarkets and Distribution\nThe Company’s customers are primarily in the consumer, small and mid-sized business, education, enterprise and government markets. The Company sells its\nproducts and resells third-party products in most of its major markets directly to customers through its retail and online stores and its direct sales force. The Company\nalso employs a variety of indirect distribution channels, such as third-party cellular network carriers, wholesalers, retailers and resellers. During 2023, the Company’s\nnet sales through its direct and indirect distribution channels accounted for 37% and 63%, respectively, of total net sales.\nCompetition\nThe markets for the Company’s products and services are highly competitive, and are characterized by aggressive price competition and resulting downward pressure\non gross margins, frequent introduction of new products and services, short product life cycles, evolving industry standards, continual improvement in product price\nand performance characteristics, rapid adoption of technological advancements by competitors, and price sensitivity on the part of consumers and businesses. Many\nof the Company’s competitors seek to compete primarily through aggressive pricing and very low cost structures, and by imitating the Company’s products and\ninfringing on its intellectual property.\n®\n®\n®\nSM\n®\n®\n®\n®\n®\nApple Inc. | 2023 Form 10-K | 2",
                "source_num": 5,
            },
            {
                "node_id": "fed9d782-2f66-4d8d-985b-89cee3b7bd24",
                "text": "This Annual Report on Form 10-K (“Form 10-K”) contains forward-looking statements, within the meaning of the Private Securities Litigation Reform Act of 1995, that\ninvolve risks and uncertainties. Many of the forward-looking statements are located in Part I, Item 1 of this Form 10-K under the heading “Business” and Part II, Item 7\nof this Form 10-K under the heading “Management’s Discussion and Analysis of Financial Condition and Results of Operations.” Forward-looking statements provide\ncurrent expectations of future events based on certain assumptions and include any statement that does not directly relate to any historical or current fact. For\nexample, statements in this Form 10-K regarding the potential future impact of macroeconomic conditions on the Company’s business and results of operations are\nforward-looking statements. Forward-looking statements can also be identiﬁed by words such as “future,” “anticipates,” “believes,” “estimates,” “expects,” “intends,”\n“plans,” “predicts,” “will,” “would,” “could,” “can,” “may,” and similar terms. Forward-looking statements are not guarantees of future performance and the Company’s\nactual results may differ signiﬁcantly from the results discussed in the forward-looking statements. Factors that might cause such differences include, but are not\nlimited to, those discussed in Part I, Item 1A of this Form 10-K under the heading “Risk Factors.” The Company assumes no obligation to revise or update any\nforward-looking statements for any reason, except as required by law.\nUnless otherwise stated, all information presented herein is based on the Company’s ﬁscal calendar, and references to particular years, quarters, months or periods\nrefer to the Company’s ﬁscal years ended in September and the associated quarters, months and periods of those ﬁscal years. Each of the terms the “Company” and\n“Apple” as used herein refers collectively to Apple Inc. and its wholly owned subsidiaries, unless otherwise stated.\nPART I\nItem 1.    Business\nCompany Background\nThe Company designs, manufactures and markets smartphones, personal computers, tablets, wearables and accessories, and sells a variety of related services. The\nCompany’s fiscal year is the 52- or 53-week period that ends on the last Saturday of September.\nProducts\niPhone\niPhone\n is the Company’s line of smartphones based on its iOS operating system. The iPhone line includes iPhone 15 Pro, iPhone 15, iPhone 14, iPhone 13 and\niPhone SE\n.\nMac\nMac\n is the Company’s line of personal computers based on its macOS\n operating system. The Mac line includes laptops MacBook Air\n and MacBook Pro\n, as well\nas desktops iMac\n, Mac mini\n, Mac Studio\n and Mac Pro\n.\niPad\niPad\n is the Company’s line of multipurpose tablets based on its iPadOS\n operating system. The iPad line includes iPad Pro\n, iPad Air\n, iPad and iPad mini\n.\nWearables, Home and Accessories\nWearables includes smartwatches and wireless headphones. The Company’s line of smartwatches, based on its watchOS\n operating system, includes Apple Watch\nUltra™ 2, Apple Watch\n Series 9 and Apple Watch SE\n. The Company’s line of wireless headphones includes AirPods\n, AirPods Pro\n, AirPods Max™ and Beats\nproducts.\nHome includes Apple TV\n, the Company’s media streaming and gaming device based on its tvOS\n operating system, and HomePod\n and HomePod mini\n, high-\nfidelity wireless smart speakers.\nAccessories includes Apple-branded and third-party accessories.\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\n®\nApple Inc. | 2023 Form 10-K | 1",
                "source_num": 6,
            },
            {
                "node_id": "859d5023-ebd3-42bc-8e0f-be1a9bd7c21c",
                "text": "The U.S. and China were the only countries that accounted for more than 10% of the Company’s net sales in 2023, 2022 and 2021. \nNet sales for 2023, 2022 and\n2021 and long-lived assets as of September 30, 2023 and September 24, 2022 were as follows (in millions):\n2023\n2022\n2021\nNet sales:\nU.S.\n$\n138,573\n \n$\n147,859\n \n$\n133,803\n \nChina\n72,559\n \n74,200\n \n68,366\n \nOther countries\n172,153\n \n172,269\n \n163,648\n \nTotal net sales\n$\n383,285\n \n$\n394,328\n \n$\n365,817\n \n2023\n2022\nLong-lived assets:\nU.S.\n$\n33,276\n \n$\n31,119\n \nChina \n5,778\n \n7,260\n \nOther countries\n4,661\n \n3,738\n \nTotal long-lived assets\n$\n43,715\n \n$\n42,117\n \n(1)\nChina includes Hong Kong and Taiwan.\n (1)\n(1)\nApple Inc. | 2023 Form 10-K | 48",
                "source_num": 7,
            },
            {
                "node_id": "be36f128-9beb-4e14-8c0d-d3a010a3b35d",
                "text": "Note 2 – \nRevenue\nThe Company recognizes revenue at the amount to which it expects to be entitled when control of the products or services is transferred to its customers. Control is\ngenerally transferred when the Company has a present right to payment and title and the signiﬁcant risks and rewards of ownership of products or services are\ntransferred to its customers. For most of the Company’s Products net sales, control transfers when products are shipped. For the Company’s Services net sales,\ncontrol transfers over time as services are delivered. Payment for Products and Services net sales is collected within a short period following transfer of control or\ncommencement of delivery of services, as applicable.\nThe Company records reductions to Products net sales related to future product returns, price protection and other customer incentive programs based on the\nCompany’s expectations and historical experience.\nFor arrangements with multiple performance obligations, which represent promises within an arrangement that are distinct, the Company allocates revenue to all\ndistinct performance obligations based on their relative stand-alone selling prices (“SSPs”). When available, the Company uses observable prices to determine SSPs.\nWhen observable prices are not available, SSPs are established that reﬂect the Company’s best estimates of what the selling prices of the performance obligations\nwould be if they were sold regularly on a stand-alone basis. The Company’s process for estimating SSPs without observable prices considers multiple factors that may\nvary depending upon the unique facts and circumstances related to each performance obligation including, where applicable, prices charged by the Company for\nsimilar offerings, market trends in the pricing for similar offerings, product-specific business objectives and the estimated cost to provide the performance obligation.\nThe Company has identiﬁed up to \nthree\n performance obligations regularly included in arrangements involving the sale of iPhone, Mac, iPad and certain other\nproducts. The ﬁrst performance obligation, which represents the substantial portion of the allocated sales price, is the hardware and bundled software delivered at the\ntime of sale. The second performance obligation is the right to receive certain product-related bundled services, which include iCloud\n, Siri\n and Maps. The third\nperformance obligation is the right to receive, on a when-and-if-available basis, future unspeciﬁed software upgrades relating to the software bundled with each\ndevice. The Company allocates revenue and any related discounts to these performance obligations based on their relative SSPs. Because the Company lacks\nobservable prices for the undelivered performance obligations, the allocation of revenue is based on the Company’s estimated SSPs. Revenue allocated to the\ndelivered hardware and bundled software is recognized when control has transferred to the customer, which generally occurs when the product is shipped. Revenue\nallocated to the product-related bundled services and unspeciﬁed software upgrade rights is deferred and recognized on a straight-line basis over the estimated\nperiod they are expected to be provided.\nFor certain long-term service arrangements, the Company has performance obligations for services it has not yet delivered. For these arrangements, the Company\ndoes not have a right to bill for the undelivered services. The Company has determined that any unbilled consideration relates entirely to the value of the undelivered\nservices. Accordingly, the Company has not recognized revenue, and does not disclose amounts, related to these undelivered services.\nFor the sale of third-party products where the Company obtains control of the product before transferring it to the customer, the Company recognizes revenue based\non the gross amount billed to customers. The Company considers multiple factors when determining whether it obtains control of third-party products, including\nevaluating if it can establish the price of the product, retains inventory risk for tangible products or has the responsibility for ensuring acceptability of the product. For\nthird-party applications sold through the App Store, the Company does not obtain control of the product before transferring it to the customer. Therefore, the Company\naccounts for all third-party application–related sales on a net basis by recognizing in Services net sales only the commission it retains.\n®\n®\nApple Inc. | 2023 Form 10-K | 34",
                "source_num": 8,
            },
            {
                "node_id": "eb815ea6-5d07-49d8-b090-4b73346b6815",
                "text": "Note 13 – \nSegment Information and Geographic Data\nThe Company manages its business primarily on a geographic basis. The Company’s reportable segments consist of the Americas, Europe, Greater China, Japan\nand Rest of Asia Paciﬁc. Americas includes both North and South America. Europe includes European countries, as well as India, the Middle East and Africa. Greater\nChina includes China mainland, Hong Kong and Taiwan. Rest of Asia Paciﬁc includes Australia and those Asian countries not included in the Company’s other\nreportable segments. Although the reportable segments provide similar hardware and software products and similar services, each one is managed separately to\nbetter align with the location of the Company’s customers and distribution partners and the unique market dynamics of each geographic region.\nThe Company evaluates the performance of its reportable segments based on net sales and operating income. Net sales for geographic segments are generally\nbased on the location of customers and sales through the Company’s retail stores located in those geographic locations. Operating income for each segment consists\nof net sales to third parties, related cost of sales, and operating expenses directly attributable to the segment. The information provided to the Company’s chief\noperating decision maker for purposes of making decisions and assessing segment performance excludes asset information.\nThe following table shows information by reportable segment for 2023, 2022 and 2021 (in millions):\n2023\n2022\n2021\nAmericas:\nNet sales\n$\n162,560\n \n$\n169,658\n \n$\n153,306\n \nOperating income\n$\n60,508\n \n$\n62,683\n \n$\n53,382\n \nEurope:\nNet sales\n$\n94,294\n \n$\n95,118\n \n$\n89,307\n \nOperating income\n$\n36,098\n \n$\n35,233\n \n$\n32,505\n \nGreater China:\nNet sales\n$\n72,559\n \n$\n74,200\n \n$\n68,366\n \nOperating income\n$\n30,328\n \n$\n31,153\n \n$\n28,504\n \nJapan:\nNet sales\n$\n24,257\n \n$\n25,977\n \n$\n28,482\n \nOperating income\n$\n11,888\n \n$\n12,257\n \n$\n12,798\n \nRest of Asia Pacific:\nNet sales\n$\n29,615\n \n$\n29,375\n \n$\n26,356\n \nOperating income\n$\n12,066\n \n$\n11,569\n \n$\n9,817\n \nA reconciliation of the Company’s segment operating income to the Consolidated Statements of Operations for 2023, 2022 and 2021 is as follows (in millions):\n2023\n2022\n2021\nSegment operating income\n$\n150,888\n \n$\n152,895\n \n$\n137,006\n \nResearch and development expense\n(\n29,915\n)\n(\n26,251\n)\n(\n21,914\n)\nOther corporate expenses, net \n(\n6,672\n)\n(\n7,207\n)\n(\n6,143\n)\nTotal operating income\n$\n114,301\n \n$\n119,437\n \n$\n108,949\n \n(1)\nIncludes corporate marketing expenses, certain share-based compensation expenses, various nonrecurring charges, and other separately managed general and\nadministrative costs.\n(1)\nApple Inc. | 2023 Form 10-K | 47",
                "source_num": 9,
            },
            {
                "node_id": "ac80cd9b-0dea-4736-9693-08abbcabf6dc",
                "text": "Services\nAdvertising\nThe Company’s advertising services include third-party licensing arrangements and the Company’s own advertising platforms.\nAppleCare\nThe Company offers a portfolio of fee-based service and support products under the AppleCare\n brand. The offerings provide priority access to Apple technical\nsupport, access to the global Apple authorized service network for repair and replacement services, and in many cases additional coverage for instances of accidental\ndamage or theft and loss, depending on the country and type of product.\nCloud Services\nThe Company’s cloud services store and keep customers’ content up-to-date and available across multiple Apple devices and Windows personal computers.\nDigital Content\nThe Company operates various platforms, including the App Store\n,\n that allow customers to discover and download applications and digital content, such as books,\nmusic, video, games and podcasts.\nThe Company also offers digital content through subscription-based services, including Apple Arcade\n, a game subscription service; Apple Fitness+\n, a personalized\nﬁtness service; Apple Music\n, which offers users a curated listening experience with on-demand radio stations; Apple News+\n, a subscription news and magazine\nservice; and Apple TV+\n, which offers exclusive original content and live sports.\nPayment Services\nThe Company offers payment services, including Apple Card\n, a co-branded credit card, and Apple Pay\n, a cashless payment service.\nSegments\nThe Company manages its business primarily on a geographic basis. The Company’s reportable segments consist of the Americas, Europe, Greater China, Japan\nand Rest of Asia Paciﬁc. Americas includes both North and South America. Europe includes European countries, as well as India, the Middle East and Africa. Greater\nChina includes China mainland, Hong Kong and Taiwan. Rest of Asia Paciﬁc includes Australia and those Asian countries not included in the Company’s other\nreportable segments. Although the reportable segments provide similar hardware and software products and similar services, each one is managed separately to\nbetter align with the location of the Company’s customers and distribution partners and the unique market dynamics of each geographic region.\nMarkets and Distribution\nThe Company’s customers are primarily in the consumer, small and mid-sized business, education, enterprise and government markets. The Company sells its\nproducts and resells third-party products in most of its major markets directly to customers through its retail and online stores and its direct sales force. The Company\nalso employs a variety of indirect distribution channels, such as third-party cellular network carriers, wholesalers, retailers and resellers. During 2023, the Company’s\nnet sales through its direct and indirect distribution channels accounted for 37% and 63%, respectively, of total net sales.\nCompetition\nThe markets for the Company’s products and services are highly competitive, and are characterized by aggressive price competition and resulting downward pressure\non gross margins, frequent introduction of new products and services, short product life cycles, evolving industry standards, continual improvement in product price\nand performance characteristics, rapid adoption of technological advancements by competitors, and price sensitivity on the part of consumers and businesses. Many\nof the Company’s competitors seek to compete primarily through aggressive pricing and very low cost structures, and by imitating the Company’s products and\ninfringing on its intellectual property.\n®\n®\n®\nSM\n®\n®\n®\n®\n®\nApple Inc. | 2023 Form 10-K | 2",
                "source_num": 10,
            },
            {
                "node_id": "75c053b4-711f-458c-92dc-5d662955e878",
                "text": "Investment in new business strategies and acquisitions could disrupt the Company’s ongoing business, present risks not originally contemplated and\nmaterially adversely affect the Company’s business, reputation, results of operations and financial condition.\nThe Company has invested, and in the future may invest, in new business strategies or acquisitions. Such endeavors may involve signiﬁcant risks and uncertainties,\nincluding distraction of management from current operations, greater-than-expected liabilities and expenses, economic, political, legal and regulatory challenges\nassociated with operating in new businesses, regions or countries, inadequate return on capital, potential impairment of tangible and intangible assets, and signiﬁcant\nwrite-offs. Investment and acquisition transactions are exposed to additional risks, including failing to obtain required regulatory approvals on a timely basis or at all,\nor the imposition of onerous conditions that could delay or prevent the Company from completing a transaction or otherwise limit the Company’s ability to fully realize\nthe anticipated beneﬁts of a transaction. These new ventures are inherently risky and may not be successful. The failure of any signiﬁcant investment could materially\nadversely affect the Company’s business, reputation, results of operations and financial condition.\nThe Company’s retail stores are subject to numerous risks and uncertainties.\nThe Company’s retail operations are subject to many factors that pose risks and uncertainties and could adversely impact the Company’s business, results of\noperations and ﬁnancial condition, including macroeconomic factors that could have an adverse effect on general retail activity. Other factors include the Company’s\nability to: manage costs associated with retail store construction and operation; manage relationships with existing retail partners; manage costs associated with\nfluctuations in the value of retail inventory; and obtain and renew leases in quality retail locations at a reasonable cost.\nLegal and Regulatory Compliance Risks\nThe Company’s business, results of operations and ﬁnancial condition could be adversely impacted by unfavorable results of legal proceedings or\ngovernment investigations.\nThe Company is subject to various claims, legal proceedings and government investigations that have arisen in the ordinary course of business and have not yet\nbeen fully resolved, and new matters may arise in the future. In addition, agreements entered into by the Company sometimes include indemniﬁcation provisions\nwhich can subject the Company to costs and damages in the event of a claim against an indemniﬁed third party. The number of claims, legal proceedings and\ngovernment investigations involving the Company, and the alleged magnitude of such claims, proceedings and government investigations, has generally increased\nover time and may continue to increase.\nThe Company has faced and continues to face a signiﬁcant number of patent claims relating to its cellular-enabled products, and new claims may arise in the future,\nincluding as a result of new legal or regulatory frameworks. For example, technology and other patent-holding companies frequently assert their patents and seek\nroyalties and often enter into litigation based on allegations of patent infringement or other violations of intellectual property rights. The Company is vigorously\ndefending infringement actions in courts in several U.S. jurisdictions, as well as internationally in various countries. The plaintiffs in these actions frequently seek\ninjunctions and substantial damages.\nRegardless of the merit of particular claims, defending against litigation or responding to government investigations can be expensive, time-consuming and disruptive\nto the Company’s operations. In recognition of these considerations, the Company may enter into agreements or other arrangements to settle litigation and resolve\nsuch challenges. There can be no assurance such agreements can be obtained on acceptable terms or that litigation will not occur. These agreements can also\nsigniﬁcantly increase the Company’s cost of sales and operating expenses and require the Company to change its business practices and limit the Company’s ability\nto offer certain products and services.\nExcept as described in Part I, Item 3 of this Form 10-K under the heading “Legal Proceedings” and in Part II, Item 8 of this Form 10-K in the Notes to Consolidated\nFinancial Statements in Note 12, “Commitments, Contingencies and Supply Concentrations” under the heading “Contingencies,” in the opinion of management, there\nwas not at least a reasonable possibility the Company may have incurred a material loss, or a material loss greater than a recorded accrual, concerning loss\ncontingencies for asserted legal and other claims.",
                "source_num": 11,
            },
            {
                "node_id": "2bb1faf5-d98a-4e1e-89f0-1986a749b803",
                "text": "The Company’s ability to compete successfully depends heavily on ensuring the continuing and timely introduction of innovative new products, services and\ntechnologies to the marketplace. The Company designs and develops nearly the entire solution for its products, including the hardware, operating system, numerous\nsoftware applications and related services. Principal competitive factors important to the Company include price, product and service features (including security\nfeatures), relative price and performance, product and service quality and reliability, design innovation, a strong third-party software and accessories ecosystem,\nmarketing and distribution capability, service and support, and corporate reputation.\nThe Company is focused on expanding its market opportunities related to smartphones, personal computers, tablets, wearables and accessories, and services. The\nCompany faces substantial competition in these markets from companies that have signiﬁcant technical, marketing, distribution and other resources, as well as\nestablished hardware, software, and service offerings with large customer bases. In addition, some of the Company’s competitors have broader product lines, lower-\npriced products and a larger installed base of active devices. Competition has been particularly intense as competitors have aggressively cut prices and lowered\nproduct margins. Certain competitors have the resources, experience or cost structures to provide products at little or no proﬁt or even at a loss. The Company’s\nservices compete with business models that provide content to users for free and use illegitimate means to obtain third-party digital content and applications. The\nCompany faces signiﬁcant competition as competitors imitate the Company’s product features and applications within their products, or collaborate to offer integrated\nsolutions that are more competitive than those they currently offer.\nSupply of Components\nAlthough most components essential to the Company’s business are generally available from multiple sources, certain components are currently obtained from single\nor limited sources. The Company also competes for various components with other participants in the markets for smartphones, personal computers, tablets,\nwearables and accessories. Therefore, many components used by the Company, including those that are available from multiple sources, are at times subject to\nindustry-wide shortage and significant commodity pricing fluctuations.\nThe Company uses some custom components that are not commonly used by its competitors, and new products introduced by the Company often utilize custom\ncomponents available from only one source. When a component or product uses new technologies, initial capacity constraints may exist until the suppliers’ yields\nhave matured or their manufacturing capacities have increased. The continued availability of these components at acceptable prices, or at all, may be affected if\nsuppliers decide to concentrate on the production of common components instead of components customized to meet the Company’s requirements.\nThe Company has entered into agreements for the supply of many components; however, there can be no guarantee that the Company will be able to extend or\nrenew these agreements on similar terms, or at all.\nResearch and Development\nBecause the industries in which the Company competes are characterized by rapid technological advances, the Company’s ability to compete successfully depends\nheavily upon its ability to ensure a continual and timely ﬂow of competitive products, services and technologies to the marketplace. The Company continues to\ndevelop new technologies to enhance existing products and services, and to expand the range of its offerings through research and development (“R&D”), licensing of\nintellectual property and acquisition of third-party businesses and technology.\nIntellectual Property\nThe Company currently holds a broad collection of intellectual property rights relating to certain aspects of its hardware devices, accessories, software and services.\nThis includes patents, designs, copyrights, trademarks and other forms of intellectual property rights in the U.S. and various foreign countries. Although the Company\nbelieves the ownership of such intellectual property rights is an important factor in differentiating its business and that its success does depend in part on such\nownership, the Company relies primarily on the innovative skills, technical competence and marketing abilities of its personnel.\nThe Company regularly ﬁles patent, design, copyright and trademark applications to protect innovations arising from its research, development, design and marketing,\nand is currently pursuing thousands of applications around the world. Over time, the Company has accumulated a large portfolio of issued and registered intellectual\nproperty rights around the world. No single intellectual property right is solely responsible for protecting the Company’s products and services. The Company believes\nthe duration of its intellectual property rights is adequate relative to the expected lives of its products and services.",
                "source_num": 12,
            },
        ],
    }

    separated_text = re.sub(r"\[(\d+(?:,\d+)*)\]", separate_numbers, res["text"])

    # # Extract citations using the regular expression
    numbers = re.findall(r"\[(\d+)\]", separated_text)

    # # Remove duplicates using set and convert back to a list
    unique_numbers = list(set(numbers))

    # # Sort the list in ascending order
    unique_numbers.sort()

    new_nodes = [
        node for node in res["nodes"] if str(node["source_num"]) in unique_numbers
    ]

    def increase_citation(match):
        number = int(match.group(1))
        new_number = number + offset
        return f"[{new_number}]"

    for new_num, old_num in enumerate(unique_numbers, start=1):
        separated_text = separated_text.replace(f"[{old_num}]", f"[{new_num}]")
        for node in new_nodes:
            if node["source_num"] == old_num:
                node["source_num"] = new_num

    separated_text = re.sub(r"\[(\d+)\]", increase_citation, separated_text)

    for node in new_nodes:
        node["source_num"] = node["source_num"] + offset

    # for node in res["nodes"]:
    #     node["text"] = re.sub(r"\[(\d+)\]", increase_citation, node["text"])
    #     new_nodes.append(node)

    # print(response)
    return {"response": separated_text, "nodes": new_nodes}
